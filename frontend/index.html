<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AuthMini V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body
    x-data="app()"
    class="bg-gray-100 min-h-screen flex items-center justify-center"
    x-init="init()"
  >
    <!-- Login/Register Form -->
    <div x-show="!user" class="form-container">
      <div x-data="authComponent()">
        <h2 class="text-2xl font-bold mb-4 text-white">
          AuthMini V3 Login / Register
        </h2>
        <input
          x-model="email"
          @input="validate()"
          type="email"
          placeholder="Email"
          class="w-full text-gray-700 p-2 mb-4 rounded"
        />
        <input
          x-model="password"
          @input="validate()"
          type="password"
          placeholder="Password"
          class="w-full text-gray-700 p-2 mb-4 rounded"
        />
        <button
          @click="submit('register')"
          class="btn-primary"
          :class="{ 'opacity-50 cursor-not-allowed': errors.email || errors.password }"
        >
          Register
        </button>
        <button
          @click="submit('login')"
          class="btn-primary ml-2"
          :class="{ 'opacity-50 cursor-not-allowed': errors.email || errors.password }"
        >
          Login
        </button>
        <p x-text="error" class="text-red-500 mt-2"></p>
        <p x-text="errors.email" class="text-red-500 mt-2"></p>
        <p x-text="errors.password" class="text-red-500 mt-2"></p>
      </div>
    </div>

    <!-- User Dashboard -->
    <div
      x-show="user !== null && user.role === 'user'"
      class="form-container"
    >
      <h2 class="text-2xl font-bold mb-4 text-white">
        Welcome, <span x-text="user?.email || 'User'"></span>
      </h2>
      <button @click="showProfile = true" class="btn-primary">
        Edit Profile
      </button>
      <button @click="logout()" class="btn-primary ml-2">Logout</button>
      <div x-show="showProfile" class="mt-4" x-data="profileComponent()">
        <h3 class="text-lg font-semibold mb-2 text-white">Edit Profile</h3>
        <input
          x-model="profile.displayName"
          placeholder="Display Name"
          class="w-full text-gray-700 p-2 mb-2 rounded"
        />
        <textarea
          x-model="profile.bio"
          placeholder="Bio"
          class="w-full text-gray-700 p-2 mb-2 rounded"
        ></textarea>
        <input
          x-model="profile.avatarUrl"
          placeholder="Avatar URL"
          class="w-full text-gray-700 p-2 mb-2 rounded"
        />
        <input
          x-model="password"
          type="password"
          placeholder="New Password"
          class="w-full text-gray-700 p-2 mb-2 rounded"
        />
        <select
          x-model="settings.theme"
          class="w-full text-gray-700 p-2 mb-2 rounded"
        >
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <label class="text-white">
          <input x-model="settings.notifications" type="checkbox" />
          Enable Notifications
        </label>
        <button
          @click="saveProfile()"
          class="btn-primary mt-2"
          :class="{ 'animate-pulse': loading }"
        >
          Save
        </button>
        <p x-text="error" class="text-red-500 mt-2"></p>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div
      x-show="user !== null && user.role === 'admin'"
      class="form-container"
    >
      <h2 class="text-2xl font-bold mb-4 text-white">Admin Dashboard</h2>
      <input
        x-model="search"
        @input.debounce="fetchUsers()"
        placeholder="Search users..."
        class="w-full text-gray-700 p-2 mb-4 rounded"
      />
      <div class="text-white mb-4">
        <label>
          <input
            type="radio"
            name="status"
            value=""
            x-model="activeFilter"
            @change="fetchUsers()"
          />
          All Users
        </label>
        <label class="ml-4">
          <input
            type="radio"
            name="status"
            value="true"
            x-model="activeFilter"
            @change="fetchUsers()"
          />
          Active Users
        </label>
        <label class="ml-4">
          <input
            type="radio"
            name="status"
            value="false"
            x-model="activeFilter"
            @change="fetchUsers()"
          />
          Disabled Users
        </label>
      </div>
      <h3 class="text-lg font-semibold mb-2 text-white">Users</h3>
      <ul class="mb-4 max-h-60 overflow-y-auto">
        <template x-for="u in users" :key="u.id">
          <li
            class="text-white flex justify-between items-center py-1 border-b border-gray-600"
          >
            <span
              x-text="`${u.email} (${u.role}) - ${u.is_active ? 'Active' : 'Disabled'}`"
            ></span>
            <div>
              <button
                @click="viewUser(u.id)"
                class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded"
              >
                View
              </button>
              <button
                @click="toggleUserActive(u.id, !u.is_active)"
                class="ml-1 text-xs px-2 py-1 rounded"
                :class="u.is_active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'"
              >
                <span x-text="u.is_active ? 'Disable' : 'Enable'"></span>
              </button>
              <button
                @click="deleteUser(u.id)"
                class="ml-1 bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded"
              >
                Delete
              </button>
            </div>
          </li>
        </template>
      </ul>

      <!-- Activity Logs -->
      <h3 class="text-lg font-semibold mt-4 mb-2 text-white">
        Recent Activity
      </h3>
      <ul class="mb-4 max-h-40 overflow-y-auto">
        <template x-for="log in logs" :key="log.id">
          <li class="text-white text-sm py-1 border-b border-gray-600">
            <span
              x-text="`${new Date(log.createdAt).toLocaleString()} - ${log.user?.email || 'Unknown'}: ${log.action}`"
            ></span>
          </li>
        </template>
      </ul>

      <button
        @click="fetchUsers(); fetchLogs();"
        class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded"
      >
        Refresh Data
      </button>
      <button @click="logout()" class="btn-primary ml-2">Logout</button>

      <!-- Error message -->
      <p x-show="error" x-text="error" class="text-red-500 mt-2"></p>

      <!-- User Details Modal -->
      <div
        x-show="selectedUser"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
      >
        <div class="bg-white p-6 rounded-lg w-96 max-w-full">
          <h3
            class="text-xl font-bold mb-4"
            x-text="`User: ${selectedUser?.email}`"
          ></h3>
          <div class="mb-4">
            <p>
              <strong>ID:</strong> <span x-text="selectedUser?.id"></span>
            </p>
            <p>
              <strong>Role:</strong> <span x-text="selectedUser?.role"></span>
            </p>
            <p>
              <strong>Status:</strong>
              <span
                x-text="selectedUser?.is_active ? 'Active' : 'Disabled'"
              ></span>
            </p>
            <p>
              <strong>Created:</strong>
              <span
                x-text="new Date(selectedUser?.createdAt).toLocaleString()"
              ></span>
            </p>
          </div>

          <div class="mb-4" x-show="selectedUser?.profile">
            <h4 class="font-bold">Profile</h4>
            <p>
              <strong>Name:</strong>
              <span
                x-text="selectedUser?.profile?.displayName || 'Not set'"
              ></span>
            </p>
            <p>
              <strong>Bio:</strong>
              <span x-text="selectedUser?.profile?.bio || 'Not set'"></span>
            </p>
          </div>

          <div class="mb-4" x-show="selectedUser?.settings">
            <h4 class="font-bold">Settings</h4>
            <p>
              <strong>Theme:</strong>
              <span x-text="selectedUser?.settings?.theme"></span>
            </p>
            <p>
              <strong>Notifications:</strong>
              <span
                x-text="selectedUser?.settings?.notifications ? 'Enabled' : 'Disabled'"
              ></span>
            </p>
          </div>

          <div class="flex justify-end">
            <button
              @click="closeUserDetails()"
              class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="js/app.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/profile.js" defer></script>
    <script
      src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"
      defer
    ></script>
  </body>
</html>